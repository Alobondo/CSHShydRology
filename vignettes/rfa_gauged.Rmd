---
title: "Prediction of flood quantiles at ungauged sites"
output: 
    rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{gauged-RFA}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

## Introduction

In this document I will show how to use `CSHShydRology` to perform regional 
flood frequency analysis using pooling groups and the index-flood model.
The methodology is presented using 45 hydrometric sites located in the Atlantic 
provinces of Canada. 
The dataset `flowAtlantic` contains the annual maximums of river discharge `ams`
and catchment descriptors: drainage area, mean annual precipitation. 

## Measure of similarity

For this analysis, pooling groups are formed as the nearby sites from which 
regional information can be transfered to a site of interest (target). 
Different measures of similarity exist to identify the members of a pooling
group.
Geograpical distance and Euclidean distance between the catchment descriptors 
may be consider.
The example below shows how to obtain these distance.
Notice that the descriptors are transformed and scaled before the
Euclidean distance is computed. 
Also, the `Geodist` function use the Haversine formula to compute a great-circle 
distance between point.

```{r}
library(CSHShydRology)
attach(flowAtlantic) 

## Compute the distance between descriptors
covar <- scale(log(info[,c('area','map')]))
distance.covar <- as.matrix(dist(covar))
colnames(distance.covar) <- rownames(distance.covar) <- as.character(info$id)

## Compute great-circle distance
coord <- info[,c('lon','lat')]
distance.geo <- GeoDist(coord)
colnames(distance.geo) <- rownames(distance.geo) <- as.character(info$id)
```

Another measure of similarity is the one based on the seasonality of the annual 
maximum discharge that characterizes the type of flood regime the site
of interest.
An angular value (radian) can be attributed to the moment when a flood is 
observed 
$$
\theta_i = \mathrm{(Julian \,date)}_i\left( \frac{2\pi}{365}\right).
$$
Accordingly, a sample of $n$ angular values is summarized by averaging each 
Cartesian coordinate separately.

$$
\begin{align}
\bar x &= \frac{1}{n}\sum_{i=1}^n \cos(\theta_i) \\
\bar y &= \frac{1}{n}\sum_{i=1}^n \sin(\theta_i) 
\end{align}
$$
However, these summary statistics are easier to interpret in polar coordinates.

$$
\begin{align}
\theta &= \arctan \left( \bar y / \bar x\right)\\
r &= \sqrt{\bar x^2 + \bar y^2} \\
\end{align}
$$
Here, $\bar \theta$ represents the average moment of occurrence for the annual
maximum discharges and $\bar r$ represent its regularity during the year.
In particular, values of $\bar r$ close to 1 entails that the maximum discharge
occurs almost the same day every year, while values close to 0 imply that the 
maximum discharge could be observed at any moment of the years.
Even for regional frequency analysis based threshold modeling, Mostofi Zadeh 
et al. (2019) showed that the seasonality based on annual maximum discharges 
should be preferred.

The seasonality of one or several sites can be estimated using the `SeasonStat`
function.

```{r}
SeasonStat(ams[ams$id == ams$id[1], ]$date)
st <- SeasonStat(date ~ id, ams)
head(st)

```

Next, the distance between sites can be evaluated using the Eucledean distance
between cartesian or polar coordinates. The function `DistSeason` compute the distance between pairs $(r_j,\theta_j)$ and
$(r_k, \theta_k)$ according to

$$
h_{i,j} =\sqrt{\|r_j-r_k \|^2 + \left(\frac{\|\theta_j-\theta_k\|}{\pi}\right)^2}
$$

```{r}
## Distance using cartesian coordinates
distance.st <- as.matrix(dist(st[,c('x','y')]))
colnames(distance.geo) <- rownames(distance.geo) <- as.character(info$id)

## Distance using polar coordinates
distance.st2 <- DistSeason(radius ~ angle , st)
colnames(distance.st2) <- rownames(distance.st2) <- as.character(info$id)
```


The graphic below shows the seasonal statistics of the Atlantic rivers. 
A k-means algorithm is used to divide the sites in three regions. 
One region includes sites with more nival regimes (blue),  where annual floods 
are occurring more regularly around May.
A second region (green) represents sites with a more pluvial regime with a 
lower regularity and rainfall events occurring during winter.
Finally, a third region (orange) regroups sites with mixed regimes where 
a dominant spring freshet occurs between March and May, but where maximum 
discharges are also frequently cause by rainfalls at other moments of the year.

```{r, fig.height=5, fig.width=5}
set.seed(0)
km <- kmeans(as.dist(distance.st2), 3, nstart = 5)
regime <- c('blue','darkgreen','orange')[km$cluster]

JulianPlot()
points(st, pch = 16, col = regime)
```


## Pooling groups

The index-flood model is frequently used to evaluate flood quantile based on a 
regional growth curve that characterizes a pooling group. 
This model assumes that all at-site distributions are proportional to the same
regional growth curve up to a scale factor.
This scale factor is usually taken as the sample mean.
Most of the time, this regional growth curve is estimated using the L-moment 
algorithm that takes the average of the sample L-moments of all standardized 
distributions inside the pooling group to derive the parameters of the regional
growth curve. 
A best distribution is then selected by identifying the distribution where the 
L-moments are the most coherent with the sample estimates.
See Burn (1990) and Hosking and Wallis (1997) for a more in depth
introduction.

The example below first used the function `DataWide`, to construct a matrix of 
the data where sites are represented by columns and years by rows.
Next, nearest sites to the target `01AK007` are extracted.
Here, the target is assumed to be the site with distance 0.
Notice also that the example below makes sure that the distance matrix respect 
the order imposed by the columns of `xd`.


```{r}

## Organisation of the data in a matrix
ams$year <- format(ams$date, '%Y')
xd <- DataWide(ams ~ id + year, ams)

## Extract a pooling groups
distance.target <- distance.st2[colnames(xd),'01AK007']
xd.target <- FindNearest(xd, distance = distance.target, 25)
```

Finally, the regional growth curve is estimated using the regional L-moments.
The summary of the fitted model indicates that the best distribution is the
generalized extreme value (GEV) distribution.
This is determined by the Z-scores that identify the distribution with the 
closest L-kurtosis to its sample estimates.
A complementary tool to the Z-score is the L-moment ratio diagram 
that illustrates the L-skewness and the L-kurtosis of all sites.
It can be seen in the figure below that the average (dot) is located near the 
theoretical line of the GEV.

```{r fig.height=5, fig.width=6}

## Fit regional growth curve
fit.target <- FitRegLmom(xd.target)
fit.target

plot(fit.target)
```

To assess the hypothesis of the index-flood model, the degree of homogeneity of
the pooling group must be verified.
Accordingly, for a homogenous group each at-site L-coefficient of
variation $V$ or LCV should be close to their regional value.
Therefore, a large 
dispersion of the LCV provide evidences that the pooling groups is not homogenous. 
To this end, a common heterogeneity measure is
$$
H = \frac{V-\mu_V}{\sigma_V}
$$
where values $H < 1$ can be interpreted as acceptably homogenous, $1\leq H<2$ possibly
heterogenous and $H \geq 2$ definitely heterogenous.

A pooling group may be found overall heterogeneous only because it contents few 
heterogenous elements. 
In turns, each site can be removed from the pooling group and the one that best
improve the heterogeneity measure $H$ should be permanently removed. 
This process can be repeated until a homogenous pooling group is found or that
a given stopping criteria is reached.
The function `PoolRemove` search for the heterogenous sites, removes them and 
updates the regional growth curve.
In the present situation, two sites are removed to obtain a homogenous pooling group.

```{r}
## Remove heterogenous sites 
fit.target2 <- PoolRemove(fit.target)

## New heterogeneity measure
fit.target2$stat[1]
```


## Intersite correlation

Snow accumulation or large rainfall system may create floods that affect  
multiple sites simultaneously. 
This generates a spatial dependence that will result in 
larger uncertainties for the estimated flood quantiles in contrast to a scenario
where all sites are independent. 
Better inference for the estimated flood quantiles can be obtained by a using 
parametric bootstrap that accounts for intersite correlation.
For this resampling scheme, a multivariate Normal distribution is simulated at 
each time step and the at-site distribution are transformed to the original
scale using at-site L-moments.

The spearman correlation $\rho_{i,j}$ between pairs of the i-th and j-th sites 
measure the degree of association between series of flood events.
This measure is well suited to quantify the intersite correlations between 
paired observations as it is not affected by the at-site distributions.
The relation
$$
\theta_{i,j} = 2 \sin\left(\rho_{i,j}\frac{\pi}{6}\right)
$$
links the correlation coefficients $\theta_{i,j}$ of the 
multivariate Normal distribution to the spearman correlation.
However, corrections should be done to ensure that the final covariance matrix
is positive definite (Higham, 2002).


The function `Intersite` can be used to estimate the parameter of the
multivariate normal distribution.
The output is a list containing among others the correlation coefficient `$corr`
and their corrected value `model`.
The function `sitename` can be used to extract the names of the sites in a 
pooling group.
This is useful to extract data or distance matrix from the pooling groups after
heterogenous site have been extracted.

```{r}
sid <- sitenames(fit.target2)
icor <- Intersite(xd[,sid])
round(icor$model[1:3,1:3],2)
```

Due to the spatial distribution of the physical mechanism that generates
intersite correlation. 
The strength of the dependence may depend on the distance between the sites. 
An exponential model can be fitted by the function `Intersite` if a distance $h$
is provided. 
Note that it is important that the order of the column in the matrix of data and
distance, be the same.
The exponential model has the form

$$
\widehat{\theta}_{i,j} = \begin{cases}
(1-\tau) \exp\left(-3 \left|\frac{h}{\gamma}\right|^p \right) & h > 0  \\
1 & h = 0\\
\end{cases}
$$
where the nugget effect $\tau \in [0,1]$ that represents a discontinuity at the 
origin $h = 0$ and the range parameter $\gamma > 0$ that controls the decay of 
the correlation with respect to the distance are estimated by weighted least 
squares with weights proportional to the number of paired observations.


```{r fig.height=5, fig.width=6}

## Fit the exponential model
geo.target <- distance.geo[sid,sid]

icor2 <- Intersite(xd[,sid], method = 'exp',
                   distance = geo.target, 
                   distance.max = 300)
icor2

## Display the results
theta <- icor2$corr[lower.tri(icor2$corr)]
theta.model <- icor2$model[lower.tri(icor2$corr)]
h <- geo.target[lower.tri(icor2$corr)]

plot(h, theta, pch = '.', cex = 2)
points(h, theta.model, col = 'red', pch = 16)

```


## Flood quantiles

Flood quantiles can be obtained from the function `predict`. 
However to obtain reliable confidence intervals, bootstraps is necessary and so
the covariance matrix of the multivariate Normal distribution must be passed
as an argument.
The argument `corr` can also be a single value that corresponds to a 
constant coefficient of correlation.
When, the function `Intersite` evaluates the covariance correlation matrix 
empirically, it evaluated the average coefficient of correlation that can 
be used as a common value.

```{r}
predict(fit.target2, q = c(.9, .99), ci = TRUE, corr = icor$model)

predict(fit.target2, q = c(.9, .99), ci = TRUE, corr = icor$para)
```

## Conclusion

In this document we showed how to perform a regional flood frequency analysis 
using similarity based seasonal statistics and pooling groups.
First seasonal statistics were evaluated (`SeasonStat`) as well as the
the pairwise distance (`DistSeason`) of the sites in the seasonal space.
The annual maximums were then reorganized in a matrix with sites in columns
and years in rows (`DataWide`).
Next, the nearest sites to a target were identified (`FindNearest`) and 
an index flood model was fitted (`FitRegLmom`) using the L-moments algorithm.
It was found that the pooling group of the target was not homogenous. 
The most heterogenous sites were then removed in a stepwise manner 
(`PoolRemove`) and the flood quantiles were finally estimated (`predict`).
To account for the intersite correlation that may lead to underestimate the 
true uncertainty of the estimated flood quantiles, 
a power exponential model was considered (`Intersite`).

## References

* Burn, D. H. (1990). An appraisal of the “region of influence” approach to flood
  frequency analysis. Hydrological Sciences Journal, 35(2), 149–165.
  https://doi.org/10.1080/02626669009492415

* Burn, D. H. (1997). Catchment similarity for regional flood frequency analysis 
  using seasonality measures. Journal of Hydrology, 202(1–4), 212–230.
  https://doi.org/10.1016/S0022-1694(97)00068-1

* Durocher, M., Burn, D. H., & Mostofi Zadeh, S. (2018). A nationwide regional 
  flood frequency analysis at ungauged sites using ROI/GLS with copulas and 
  super regions. Journal of Hydrology, 567, 191–202. 
  https://doi.org/10.1016/j.jhydrol.2018.10.011


* Higham, Nick (2002). Computing the nearest correlation matrix - a problem 
  from finance; IMA Journal of Numerical Analysis 22, 329–343.
  https://doi.org/10.1093/imanum/22.3.329
  
* Hosking, J. R. M., & Wallis, J. R. (1997). Regional frequency analysis: an 
  approach based on L-moments. Cambridge Univ Pr.

* Mostofi Zadeh, S., Durocher, M., Burn, D. H., & Ashkar, F. (2019). Pooled flood 
  frequency analysis: a comparison based on peaks-over-threshold and annual 
  maximum series. Hydrological Sciences Journal, 0(ja), null.
  https://doi.org/10.1080/02626667.2019.1577556
