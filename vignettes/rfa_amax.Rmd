---
title: "At-site flood frequency analysis using annual maximums"
output: 
    rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{annual-maximums}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

## Introduction

This document shows how to use `CSHShydRology` to perform at-site 
flood frequency analysis using annual maximums of river discharge.
The procedure is illustrated using daily streamflow data from the Saint-John 
River at Fort Kent (NB).

```{r}
library(CSHShydRology)
data("flowStJohn")
```

First we need to extract the annual maximums, which are store in a dataset 
`flowStJohn` having two columns: `date` and `flow`. 
This extraction can be done using the function `ExtractAmax`.
Here, incomplete years of data (less than 365 days) are removed.
In total, the function identifies 88 annual maximums.

```{r}
## Extract the annual maximums
anData <- ExtractAmax(flow ~ date, flowStJohn, tol = 365)
nrow(anData)
```

The annual maximums are assumed to be independent and identically distributed.
To verify the likelihood of these hypothesis tests should performed to look for
potential trends (Mann-Kendall) or change points (Pettitt).
Risk is commonly measured in terms of return period $T$, which characterizes the 
average waiting time between two extreme events, which is equivalent to evaluate
the flood quantile associated with the probability $p = 1-1/T$.
 

## Estimation of the flood quantiles

Different distributions can be considered to model the annual maximums.
Nevertheless, according to extreme value theory the distribution of
sample maximums should converge to a Generalized Extreme Value (GEV) 
distribution as the size of the sample increase
$$
F(x) = \exp\left\{ - \left[ 1 - \kappa \left(\frac{x-\xi}{\alpha} \right) 
  \right]^{1/\kappa} \right\}.
$$
where $\xi$ is a location parameter, $\alpha > 0$ is a scale parameter and
$\kappa$ is a shape parameter. 
The GEV distribution can be fitted using the `FitAmax` function. 
The example below used the maximum likelihood method to estimate the  
three parameters of the GEV distribution. 

```{r}
fitMle <- FitAmax(anData$flow, 'gev', method = 'mle')
print(fitMle)
```

Alternatively, the L-moment method can be specified with argument 
`method = 'lmom'`.
By default, `FitAmax` evaluates the covariance matrix of the estimated
parameters.
This is derived analytically for the maximum likelihood method, while for 
the L-moment method a parametric bootstrap is needed.
Note, that the evaluation of the covariance matrix can be turn off by passing 
the arguments `varcov = FALSE`.

The flood quantile of the GEV distribution are evaluated according to 
$$
x_T = \mu + \frac{\alpha}{\xi}\left[ 1+\log(1/T)^\kappa \right] .
$$
These quantities are provided by the function `predict`.
The example below indicates how to obtain the flood quantile of return periods 
10 and 100 years.
The standard deviation of the flood quantiles is estimated using the Delta 
method, as requested by the argument `se = TRUE`. 
When the argument `ci = 'delta'` is passed, confidence intervals are 
obtained by adding and substrating a value proportional to the standard 
deviation.


```{r}
## Flood quantiles of 10 and 100 return periods
predict(fitMle, q = c(.9,.99), se = TRUE, ci = 'delta', alpha = .1)
```


Alternatively, confidence intervals can be obtained using parametric bootstraps 
using the option `ci = 'boot'`.
The argument `out.matrix` can be used to request that the bootstrap 
samples be returned.

```{r}
## Fitting using L-moments
fitLmm <- FitAmax(anData$flow, 'gev', method = 'lmom', varcov = FALSE)

## Prediction using bootstrap
out <- predict(fitLmm, q = c(.9,.99), ci = 'boot', 
               nsim = 1000, out.matrix = TRUE)

## Structure of the output
names(out)
```


## Verification of the model

The return level plot provides a visual assessment of the fitted distribution by 
comparing the sample and theoritical flood quantiles.
For convinience, the x-axis is expressed in term of the return periods.
Below, the graphic shows that the estimated flood quantiles have a good 
agreement.

```{r, fig.height= 4,fig.width=6  }
## Return level plot
plot(fitMle, ci = TRUE)
```

Another diagnostic is the goodness of fit test of Anderson-Darling that verifies
if the observations were likely to be generated by a GEV distribution. 
A p-value superior for instance 0.05 indicates that the hypothesis of a GEV cannot 
be rejected at this significant level.

```{r}
## Anderson-Darling test of goodness of fit
GofTest(fitLmm, nsim = 1000)
```

## Selection of the best distribution

The GEV distribution is not the only distribution available to carry out
flood frequency analysis.
Common alternatives are the shifted log-normal distribution 
(`'ln3'`), the Generalized logistic distribution (`'glo'`) and the Pearson 
type III distribution (`'pe3'`).
These distribution can also be fitted by the function `FitAmax` as shown below.

```{r}
## Fitting of the Log-normal distribution
FitAmax(anData$flow, 'ln3', varcov = FALSE)
```

When more than one distribution is passed, a best distribution is selected 
using the Akaike Information Criterion (AIC). 
Here, all candidates have similar AIC, which indicates that all distributions 
represent reasonable choices. 

```{r}
## Candidates distribution
candidates <- c('gev','glo','ln3','pe3')

## Function that computes the AIC for a given distribution
FAIC <- function(d)
   AIC(FitAmax(anData$flow, d, method = 'mle'))

## AIC of all distributions
sapply(candidates, FAIC)

## Automatic selection of the distribution
FitAmax(anData$flow, candidates, method = 'mle')$distr
```

## Conclusion

This document showed how to evaluate flood quantiles using annual maximum 
of river discharge.
Initially, annual maximums (`ExtractAmax`) were extracted and a 
GEV distribution was fitted (`FitAmax`). 
The AIC criteria was then used to identify if there will be a better
distributions among a small group of candidates. 
The function to obtain the flood quantiles and their uncertainties (`predict`) 
was finally presented.
To assess the outcomes of the model, the return level plot (`plot`) was 
presented as a way to visualize the quality of the fitting and a
goodness of fit test was discussed (`GofTest`).
For a more in depth introduction the readers are referred to Coles (2001) 
and Hosking and Wallis (1997).

## References

Coles, S., 2001. An introduction to statistical modeling of extreme values. 
  Springer Verlag.

Hosking, J.R.M., Wallis, J.R., 1997. Regional frequency analysis: an approach 
  based on L-moments. Cambridge Univ Pr.
 